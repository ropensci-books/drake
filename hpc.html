<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 12 High-performance computing | The drake R Package User Manual</title>
  <meta name="description" content="In-depth walkthroughs and examples of drake, an R package for reproducible computation at scale." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 12 High-performance computing | The drake R Package User Manual" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://books.ropensci.org/drake/" />
  <meta property="og:image" content="https://books.ropensci.org/drake//images/logo.png" />
  <meta property="og:description" content="In-depth walkthroughs and examples of drake, an R package for reproducible computation at scale." />
  <meta name="github-repo" content="ropensci-books/drake" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 High-performance computing | The drake R Package User Manual" />
  
  <meta name="twitter:description" content="In-depth walkthroughs and examples of drake, an R package for reproducible computation at scale." />
  <meta name="twitter:image" content="https://books.ropensci.org/drake//images/logo.png" />

<meta name="author" content="Will Landau, Kirill Müller, Alex Axthelm, Jasper Clarkberg, Lorenz Walthert, Ellis Hughes, Matthew Mark Strasiotto" />
<meta name="author" content="Copyright Eli Lilly and Company" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/apple-touch-icon.png" />
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="gsp.html"/>
<link rel="next" href="time.html"/>
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script>
<script src="libs/d3-4.5.0/d3.min.js"></script>
<script src="libs/sankey-1/sankey.js"></script>
<script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-150843595-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-150843595-1');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="https://ropensci.github.io/dev_guide/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The drake R Package User Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-drake-r-package"><i class="fa fa-check"></i><b>1.1</b> The drake R package</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#why-drake"><i class="fa fa-check"></i><b>1.3</b> Why drake?</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#what-gets-done-stays-done."><i class="fa fa-check"></i><b>1.3.1</b> What gets done stays done.</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#reproducibility-with-confidence"><i class="fa fa-check"></i><b>1.3.2</b> Reproducibility with confidence</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#scale-up-and-out."><i class="fa fa-check"></i><b>1.3.3</b> Scale up and out.</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#with-docker"><i class="fa fa-check"></i><b>1.4</b> With Docker</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#documentation"><i class="fa fa-check"></i><b>1.5</b> Documentation</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="index.html"><a href="index.html#core-concepts"><i class="fa fa-check"></i><b>1.5.1</b> Core concepts</a></li>
<li class="chapter" data-level="1.5.2" data-path="index.html"><a href="index.html#in-practice"><i class="fa fa-check"></i><b>1.5.2</b> In practice</a></li>
<li class="chapter" data-level="1.5.3" data-path="index.html"><a href="index.html#use-cases"><i class="fa fa-check"></i><b>1.5.3</b> Use cases</a></li>
<li class="chapter" data-level="1.5.4" data-path="index.html"><a href="index.html#drake-projects-as-r-packages"><i class="fa fa-check"></i><b>1.5.4</b> <code>drake</code> projects as R packages</a></li>
<li class="chapter" data-level="1.5.5" data-path="index.html"><a href="index.html#frequently-asked-questions"><i class="fa fa-check"></i><b>1.5.5</b> Frequently asked questions</a></li>
<li class="chapter" data-level="1.5.6" data-path="index.html"><a href="index.html#reference"><i class="fa fa-check"></i><b>1.5.6</b> Reference</a></li>
<li class="chapter" data-level="1.5.7" data-path="index.html"><a href="index.html#function-reference"><i class="fa fa-check"></i><b>1.5.7</b> Function reference</a></li>
<li class="chapter" data-level="1.5.8" data-path="index.html"><a href="index.html#tutorials"><i class="fa fa-check"></i><b>1.5.8</b> Tutorials</a></li>
<li class="chapter" data-level="1.5.9" data-path="index.html"><a href="index.html#examples"><i class="fa fa-check"></i><b>1.5.9</b> Examples</a></li>
<li class="chapter" data-level="1.5.10" data-path="index.html"><a href="index.html#presentations"><i class="fa fa-check"></i><b>1.5.10</b> Presentations</a></li>
<li class="chapter" data-level="1.5.11" data-path="index.html"><a href="index.html#context-and-history"><i class="fa fa-check"></i><b>1.5.11</b> Context and history</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#help-and-troubleshooting"><i class="fa fa-check"></i><b>1.6</b> Help and troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="similar-work.html"><a href="similar-work.html"><i class="fa fa-check"></i><b>2</b> Similar work</a>
<ul>
<li class="chapter" data-level="2.1" data-path="similar-work.html"><a href="similar-work.html#pipeline-tools"><i class="fa fa-check"></i><b>2.1</b> Pipeline tools</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="similar-work.html"><a href="similar-work.html#gnu-make"><i class="fa fa-check"></i><b>2.1.1</b> GNU Make</a></li>
<li class="chapter" data-level="2.1.2" data-path="similar-work.html"><a href="similar-work.html#remake"><i class="fa fa-check"></i><b>2.1.2</b> Remake</a></li>
<li class="chapter" data-level="2.1.3" data-path="similar-work.html"><a href="similar-work.html#factuals-drake"><i class="fa fa-check"></i><b>2.1.3</b> Factual’s Drake</a></li>
<li class="chapter" data-level="2.1.4" data-path="similar-work.html"><a href="similar-work.html#other-pipeline-tools"><i class="fa fa-check"></i><b>2.1.4</b> Other pipeline tools</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="similar-work.html"><a href="similar-work.html#memoization"><i class="fa fa-check"></i><b>2.2</b> Memoization</a></li>
<li class="chapter" data-level="2.3" data-path="similar-work.html"><a href="similar-work.html#literate-programming"><i class="fa fa-check"></i><b>2.3</b> Literate programming</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="similar-work.html"><a href="similar-work.html#knitr-and-r-markdown"><i class="fa fa-check"></i><b>2.3.1</b> knitr and R Markdown</a></li>
<li class="chapter" data-level="2.3.2" data-path="similar-work.html"><a href="similar-work.html#version-control"><i class="fa fa-check"></i><b>2.3.2</b> Version control</a></li>
<li class="chapter" data-level="2.3.3" data-path="similar-work.html"><a href="similar-work.html#containerization-and-r-package-environments"><i class="fa fa-check"></i><b>2.3.3</b> Containerization and R package environments</a></li>
<li class="chapter" data-level="2.3.4" data-path="similar-work.html"><a href="similar-work.html#workflowr"><i class="fa fa-check"></i><b>2.3.4</b> workflowr</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="similar-work.html"><a href="similar-work.html#acknowledgements"><i class="fa fa-check"></i><b>2.4</b> Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Getting started</b></span></li>
<li class="chapter" data-level="3" data-path="walkthrough.html"><a href="walkthrough.html"><i class="fa fa-check"></i><b>3</b> Walkthrough</a>
<ul>
<li class="chapter" data-level="3.1" data-path="walkthrough.html"><a href="walkthrough.html#set-the-stage."><i class="fa fa-check"></i><b>3.1</b> Set the stage.</a></li>
<li class="chapter" data-level="3.2" data-path="walkthrough.html"><a href="walkthrough.html#make-your-results."><i class="fa fa-check"></i><b>3.2</b> Make your results.</a></li>
<li class="chapter" data-level="3.3" data-path="walkthrough.html"><a href="walkthrough.html#go-back-and-fix-things."><i class="fa fa-check"></i><b>3.3</b> Go back and fix things.</a></li>
<li class="chapter" data-level="3.4" data-path="walkthrough.html"><a href="walkthrough.html#history-and-provenance"><i class="fa fa-check"></i><b>3.4</b> History and provenance</a></li>
<li class="chapter" data-level="3.5" data-path="walkthrough.html"><a href="walkthrough.html#reproducible-data-recovery-and-renaming"><i class="fa fa-check"></i><b>3.5</b> Reproducible data recovery and renaming</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="walkthrough.html"><a href="walkthrough.html#undoing-clean"><i class="fa fa-check"></i><b>3.5.1</b> Undoing <code>clean()</code></a></li>
<li class="chapter" data-level="3.5.2" data-path="walkthrough.html"><a href="walkthrough.html#renaming"><i class="fa fa-check"></i><b>3.5.2</b> Renaming</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="walkthrough.html"><a href="walkthrough.html#try-the-code-yourself"><i class="fa fa-check"></i><b>3.6</b> Try the code yourself!</a></li>
<li class="chapter" data-level="3.7" data-path="walkthrough.html"><a href="walkthrough.html#thanks"><i class="fa fa-check"></i><b>3.7</b> Thanks</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="plans.html"><a href="plans.html"><i class="fa fa-check"></i><b>4</b> <code>drake</code> plans</a>
<ul>
<li class="chapter" data-level="4.1" data-path="plans.html"><a href="plans.html#functions"><i class="fa fa-check"></i><b>4.1</b> Functions</a></li>
<li class="chapter" data-level="4.2" data-path="plans.html"><a href="plans.html#intro-to-plans"><i class="fa fa-check"></i><b>4.2</b> Intro to plans</a></li>
<li class="chapter" data-level="4.3" data-path="plans.html"><a href="plans.html#how-to-choose-good-targets"><i class="fa fa-check"></i><b>4.3</b> How to choose good targets</a></li>
<li class="chapter" data-level="4.4" data-path="plans.html"><a href="plans.html#special-data-formats-for-targets"><i class="fa fa-check"></i><b>4.4</b> Special data formats for targets</a></li>
<li class="chapter" data-level="4.5" data-path="plans.html"><a href="plans.html#special-columns"><i class="fa fa-check"></i><b>4.5</b> Special columns</a></li>
<li class="chapter" data-level="4.6" data-path="plans.html"><a href="plans.html#static-files"><i class="fa fa-check"></i><b>4.6</b> Static files</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="plans.html"><a href="plans.html#urls"><i class="fa fa-check"></i><b>4.6.1</b> URLs</a></li>
<li class="chapter" data-level="4.6.2" data-path="plans.html"><a href="plans.html#limitations-of-static-files"><i class="fa fa-check"></i><b>4.6.2</b> Limitations of static files</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="plans.html"><a href="plans.html#dynamic-files"><i class="fa fa-check"></i><b>4.7</b> Dynamic files</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="plans.html"><a href="plans.html#how-to-use-dynamic-files"><i class="fa fa-check"></i><b>4.7.1</b> How to use dynamic files</a></li>
<li class="chapter" data-level="4.7.2" data-path="plans.html"><a href="plans.html#example-of-dynamic-files"><i class="fa fa-check"></i><b>4.7.2</b> Example of dynamic files</a></li>
<li class="chapter" data-level="4.7.3" data-path="plans.html"><a href="plans.html#limitations-of-dynamic-files"><i class="fa fa-check"></i><b>4.7.3</b> Limitations of dynamic files</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="plans.html"><a href="plans.html#large-plans"><i class="fa fa-check"></i><b>4.8</b> Large plans</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="static.html"><a href="static.html"><i class="fa fa-check"></i><b>5</b> Static branching</a>
<ul>
<li class="chapter" data-level="5.1" data-path="static.html"><a href="static.html#why-static-branching"><i class="fa fa-check"></i><b>5.1</b> Why static branching?</a></li>
<li class="chapter" data-level="5.2" data-path="static.html"><a href="static.html#grouping-variables"><i class="fa fa-check"></i><b>5.2</b> Grouping variables</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="static.html"><a href="static.html#limitations-of-grouping-variables"><i class="fa fa-check"></i><b>5.2.1</b> Limitations of grouping variables</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="static.html"><a href="static.html#tidy-evaluation"><i class="fa fa-check"></i><b>5.3</b> Tidy evaluation</a></li>
<li class="chapter" data-level="5.4" data-path="static.html"><a href="static.html#static-transformations"><i class="fa fa-check"></i><b>5.4</b> Static transformations</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="static.html"><a href="static.html#map"><i class="fa fa-check"></i><b>5.4.1</b> <code>map()</code></a></li>
<li class="chapter" data-level="5.4.2" data-path="static.html"><a href="static.html#cross"><i class="fa fa-check"></i><b>5.4.2</b> <code>cross()</code></a></li>
<li class="chapter" data-level="5.4.3" data-path="static.html"><a href="static.html#split"><i class="fa fa-check"></i><b>5.4.3</b> <code>split()</code></a></li>
<li class="chapter" data-level="5.4.4" data-path="static.html"><a href="static.html#combine"><i class="fa fa-check"></i><b>5.4.4</b> <code>combine()</code></a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="static.html"><a href="static.html#target-names"><i class="fa fa-check"></i><b>5.5</b> Target names</a></li>
<li class="chapter" data-level="5.6" data-path="static.html"><a href="static.html#tags"><i class="fa fa-check"></i><b>5.6</b> Tags</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="dynamic.html"><a href="dynamic.html"><i class="fa fa-check"></i><b>6</b> Dynamic branching</a>
<ul>
<li class="chapter" data-level="6.1" data-path="dynamic.html"><a href="dynamic.html#a-note-about-versions"><i class="fa fa-check"></i><b>6.1</b> A note about versions</a></li>
<li class="chapter" data-level="6.2" data-path="dynamic.html"><a href="dynamic.html#motivation"><i class="fa fa-check"></i><b>6.2</b> Motivation</a></li>
<li class="chapter" data-level="6.3" data-path="dynamic.html"><a href="dynamic.html#which-kind-of-branching-should-i-use"><i class="fa fa-check"></i><b>6.3</b> Which kind of branching should I use?</a></li>
<li class="chapter" data-level="6.4" data-path="dynamic.html"><a href="dynamic.html#dynamic-targets"><i class="fa fa-check"></i><b>6.4</b> Dynamic targets</a></li>
<li class="chapter" data-level="6.5" data-path="dynamic.html"><a href="dynamic.html#dynamic-transformations"><i class="fa fa-check"></i><b>6.5</b> Dynamic transformations</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="static.html"><a href="static.html#map"><i class="fa fa-check"></i><b>6.5.1</b> <code>map()</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="static.html"><a href="static.html#cross"><i class="fa fa-check"></i><b>6.5.2</b> <code>cross()</code></a></li>
<li class="chapter" data-level="6.5.3" data-path="dynamic.html"><a href="dynamic.html#group"><i class="fa fa-check"></i><b>6.5.3</b> <code>group()</code></a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="dynamic.html"><a href="dynamic.html#trace"><i class="fa fa-check"></i><b>6.6</b> Trace</a></li>
<li class="chapter" data-level="6.7" data-path="dynamic.html"><a href="dynamic.html#max_expand"><i class="fa fa-check"></i><b>6.7</b> <code>max_expand</code></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="projects.html"><a href="projects.html"><i class="fa fa-check"></i><b>7</b> <code>drake</code> projects</a>
<ul>
<li class="chapter" data-level="7.1" data-path="projects.html"><a href="projects.html#external-resources"><i class="fa fa-check"></i><b>7.1</b> External resources</a></li>
<li class="chapter" data-level="7.2" data-path="projects.html"><a href="projects.html#code-files"><i class="fa fa-check"></i><b>7.2</b> Code files</a></li>
<li class="chapter" data-level="7.3" data-path="projects.html"><a href="projects.html#safer-interactivity"><i class="fa fa-check"></i><b>7.3</b> Safer interactivity</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="dynamic.html"><a href="dynamic.html#motivation"><i class="fa fa-check"></i><b>7.3.1</b> Motivation</a></li>
<li class="chapter" data-level="7.3.2" data-path="projects.html"><a href="projects.html#usage"><i class="fa fa-check"></i><b>7.3.2</b> Usage</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="projects.html"><a href="projects.html#script-file-pitfalls"><i class="fa fa-check"></i><b>7.4</b> Script file pitfalls</a></li>
<li class="chapter" data-level="7.5" data-path="projects.html"><a href="projects.html#workflows-as-r-packages"><i class="fa fa-check"></i><b>7.5</b> Workflows as R packages</a></li>
<li class="chapter" data-level="7.6" data-path="projects.html"><a href="projects.html#other-tools"><i class="fa fa-check"></i><b>7.6</b> Other tools</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="scripts.html"><a href="scripts.html"><i class="fa fa-check"></i><b>8</b> Script-based workflows</a>
<ul>
<li class="chapter" data-level="8.1" data-path="scripts.html"><a href="scripts.html#function-oriented-workflows"><i class="fa fa-check"></i><b>8.1</b> Function-oriented workflows</a></li>
<li class="chapter" data-level="8.2" data-path="scripts.html"><a href="scripts.html#traditional-and-legacy-workflows"><i class="fa fa-check"></i><b>8.2</b> Traditional and legacy workflows</a></li>
<li class="chapter" data-level="8.3" data-path="scripts.html"><a href="scripts.html#overcoming-technical-debt"><i class="fa fa-check"></i><b>8.3</b> Overcoming Technical Debt</a></li>
<li class="chapter" data-level="8.4" data-path="scripts.html"><a href="scripts.html#dependencies"><i class="fa fa-check"></i><b>8.4</b> Dependencies</a></li>
<li class="chapter" data-level="8.5" data-path="scripts.html"><a href="scripts.html#building-the-connections"><i class="fa fa-check"></i><b>8.5</b> Building the connections</a></li>
<li class="chapter" data-level="8.6" data-path="scripts.html"><a href="scripts.html#run-the-workflow"><i class="fa fa-check"></i><b>8.6</b> Run the workflow</a></li>
<li class="chapter" data-level="8.7" data-path="scripts.html"><a href="scripts.html#keeping-the-results-up-to-date"><i class="fa fa-check"></i><b>8.7</b> Keeping the results up to date</a></li>
<li class="chapter" data-level="8.8" data-path="scripts.html"><a href="scripts.html#final-thoughts"><i class="fa fa-check"></i><b>8.8</b> Final thoughts</a></li>
</ul></li>
<li class="part"><span><b>II Examples</b></span></li>
<li class="chapter" data-level="9" data-path="churn.html"><a href="churn.html"><i class="fa fa-check"></i><b>9</b> Customer churn and deep learning</a>
<ul>
<li class="chapter" data-level="9.1" data-path="churn.html"><a href="churn.html#packages"><i class="fa fa-check"></i><b>9.1</b> Packages</a></li>
<li class="chapter" data-level="9.2" data-path="plans.html"><a href="plans.html#functions"><i class="fa fa-check"></i><b>9.2</b> Functions</a></li>
<li class="chapter" data-level="9.3" data-path="churn.html"><a href="churn.html#plan"><i class="fa fa-check"></i><b>9.3</b> Plan</a></li>
<li class="chapter" data-level="9.4" data-path="churn.html"><a href="churn.html#dependency-graph"><i class="fa fa-check"></i><b>9.4</b> Dependency graph</a></li>
<li class="chapter" data-level="9.5" data-path="churn.html"><a href="churn.html#run-the-models"><i class="fa fa-check"></i><b>9.5</b> Run the models</a></li>
<li class="chapter" data-level="9.6" data-path="churn.html"><a href="churn.html#inspect-the-results"><i class="fa fa-check"></i><b>9.6</b> Inspect the results</a></li>
<li class="chapter" data-level="9.7" data-path="churn.html"><a href="churn.html#add-models"><i class="fa fa-check"></i><b>9.7</b> Add models</a></li>
<li class="chapter" data-level="9.8" data-path="churn.html"><a href="churn.html#inspect-the-results-again"><i class="fa fa-check"></i><b>9.8</b> Inspect the results again</a></li>
<li class="chapter" data-level="9.9" data-path="churn.html"><a href="churn.html#update-your-code"><i class="fa fa-check"></i><b>9.9</b> Update your code</a></li>
<li class="chapter" data-level="9.10" data-path="walkthrough.html"><a href="walkthrough.html#history-and-provenance"><i class="fa fa-check"></i><b>9.10</b> History and provenance</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="churn.html"><a href="churn.html#packages"><i class="fa fa-check"></i><b>10</b> An analysis of R package download trends</a>
<ul>
<li class="chapter" data-level="10.1" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>10.1</b> Get the code.</a></li>
<li class="chapter" data-level="10.2" data-path="packages.html"><a href="packages.html#overview"><i class="fa fa-check"></i><b>10.2</b> Overview</a></li>
<li class="chapter" data-level="10.3" data-path="packages.html"><a href="packages.html#analysis"><i class="fa fa-check"></i><b>10.3</b> Analysis</a></li>
<li class="chapter" data-level="10.4" data-path="packages.html"><a href="packages.html#other-ways-to-trigger-downloads"><i class="fa fa-check"></i><b>10.4</b> Other ways to trigger downloads</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="gsp.html"><a href="gsp.html"><i class="fa fa-check"></i><b>11</b> Finding the best model of gross state product</a>
<ul>
<li class="chapter" data-level="11.1" data-path="packages.html"><a href="packages.html#get-the-code."><i class="fa fa-check"></i><b>11.1</b> Get the code.</a></li>
<li class="chapter" data-level="11.2" data-path="gsp.html"><a href="gsp.html#objective-and-methods"><i class="fa fa-check"></i><b>11.2</b> Objective and methods</a></li>
<li class="chapter" data-level="11.3" data-path="gsp.html"><a href="gsp.html#data"><i class="fa fa-check"></i><b>11.3</b> Data</a></li>
<li class="chapter" data-level="11.4" data-path="packages.html"><a href="packages.html#analysis"><i class="fa fa-check"></i><b>11.4</b> Analysis</a></li>
<li class="chapter" data-level="11.5" data-path="gsp.html"><a href="gsp.html#results"><i class="fa fa-check"></i><b>11.5</b> Results</a></li>
<li class="chapter" data-level="11.6" data-path="gsp.html"><a href="gsp.html#comparison-with-gnu-make"><i class="fa fa-check"></i><b>11.6</b> Comparison with GNU Make</a></li>
<li class="chapter" data-level="11.7" data-path="gsp.html"><a href="gsp.html#references"><i class="fa fa-check"></i><b>11.7</b> References</a></li>
</ul></li>
<li class="part"><span><b>III Resource management</b></span></li>
<li class="chapter" data-level="12" data-path="hpc.html"><a href="hpc.html"><i class="fa fa-check"></i><b>12</b> High-performance computing</a>
<ul>
<li class="chapter" data-level="12.1" data-path="hpc.html"><a href="hpc.html#start-small"><i class="fa fa-check"></i><b>12.1</b> Start small</a></li>
<li class="chapter" data-level="12.2" data-path="hpc.html"><a href="hpc.html#let-make-schedule-your-targets."><i class="fa fa-check"></i><b>12.2</b> Let <code>make()</code> schedule your targets.</a></li>
<li class="chapter" data-level="12.3" data-path="hpc.html"><a href="hpc.html#the-master-process"><i class="fa fa-check"></i><b>12.3</b> The master process</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="hpc.html"><a href="hpc.html#master-on-a-cluster"><i class="fa fa-check"></i><b>12.3.1</b> Master on a cluster</a></li>
<li class="chapter" data-level="12.3.2" data-path="hpc.html"><a href="hpc.html#local-master"><i class="fa fa-check"></i><b>12.3.2</b> Local master</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="hpc.html"><a href="hpc.html#parallel-backends"><i class="fa fa-check"></i><b>12.4</b> Parallel backends</a></li>
<li class="chapter" data-level="12.5" data-path="hpc.html"><a href="hpc.html#the-clustermq-backend"><i class="fa fa-check"></i><b>12.5</b> The <code>clustermq</code> backend</a>
<ul>
<li class="chapter" data-level="12.5.1" data-path="hpc.html"><a href="hpc.html#persistent-workers"><i class="fa fa-check"></i><b>12.5.1</b> Persistent workers</a></li>
<li class="chapter" data-level="12.5.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>12.5.2</b> Installation</a></li>
<li class="chapter" data-level="12.5.3" data-path="hpc.html"><a href="hpc.html#on-your-local-machine"><i class="fa fa-check"></i><b>12.5.3</b> On your local machine</a></li>
<li class="chapter" data-level="12.5.4" data-path="hpc.html"><a href="hpc.html#on-a-cluster"><i class="fa fa-check"></i><b>12.5.4</b> On a cluster</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="hpc.html"><a href="hpc.html#the-future-backend"><i class="fa fa-check"></i><b>12.6</b> The <code>future</code> backend</a>
<ul>
<li class="chapter" data-level="12.6.1" data-path="hpc.html"><a href="hpc.html#transient-workers"><i class="fa fa-check"></i><b>12.6.1</b> Transient workers</a></li>
<li class="chapter" data-level="12.6.2" data-path="hpc.html"><a href="hpc.html#installation-1"><i class="fa fa-check"></i><b>12.6.2</b> Installation</a></li>
<li class="chapter" data-level="12.6.3" data-path="hpc.html"><a href="hpc.html#on-your-local-machine-1"><i class="fa fa-check"></i><b>12.6.3</b> On your local machine</a></li>
<li class="chapter" data-level="12.6.4" data-path="hpc.html"><a href="hpc.html#on-a-cluster-1"><i class="fa fa-check"></i><b>12.6.4</b> On a cluster</a></li>
</ul></li>
<li class="chapter" data-level="12.7" data-path="hpc.html"><a href="hpc.html#advanced-options"><i class="fa fa-check"></i><b>12.7</b> Advanced options</a>
<ul>
<li class="chapter" data-level="12.7.1" data-path="hpc.html"><a href="hpc.html#selectivity"><i class="fa fa-check"></i><b>12.7.1</b> Selectivity</a></li>
<li class="chapter" data-level="12.7.2" data-path="hpc.html"><a href="hpc.html#memory-options"><i class="fa fa-check"></i><b>12.7.2</b> Memory options</a></li>
<li class="chapter" data-level="12.7.3" data-path="hpc.html"><a href="hpc.html#storage-options"><i class="fa fa-check"></i><b>12.7.3</b> Storage options</a></li>
<li class="chapter" data-level="12.7.4" data-path="hpc.html"><a href="hpc.html#the-template-argument-for-persistent-workers"><i class="fa fa-check"></i><b>12.7.4</b> The <code>template</code> argument for persistent workers</a></li>
<li class="chapter" data-level="12.7.5" data-path="hpc.html"><a href="hpc.html#the-resources-column-for-transient-workers"><i class="fa fa-check"></i><b>12.7.5</b> The <code>resources</code> column for transient workers</a></li>
<li class="chapter" data-level="12.7.6" data-path="hpc.html"><a href="hpc.html#parallel-computing-within-targets"><i class="fa fa-check"></i><b>12.7.6</b> Parallel computing <em>within</em> targets</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="time.html"><a href="time.html"><i class="fa fa-check"></i><b>13</b> Time: speed, time logging, prediction, and strategy</a>
<ul>
<li class="chapter" data-level="13.1" data-path="time.html"><a href="time.html#why-is-drake-so-slow"><i class="fa fa-check"></i><b>13.1</b> Why is <code>drake</code> so slow?</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="time.html"><a href="time.html#help-us-find-out"><i class="fa fa-check"></i><b>13.1.1</b> Help us find out!</a></li>
<li class="chapter" data-level="13.1.2" data-path="time.html"><a href="time.html#too-many-targets"><i class="fa fa-check"></i><b>13.1.2</b> Too many targets?</a></li>
<li class="chapter" data-level="13.1.3" data-path="time.html"><a href="time.html#big-data"><i class="fa fa-check"></i><b>13.1.3</b> Big data?</a></li>
<li class="chapter" data-level="13.1.4" data-path="time.html"><a href="time.html#aggressive-shortcuts"><i class="fa fa-check"></i><b>13.1.4</b> Aggressive shortcuts</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="time.html"><a href="time.html#time-logging"><i class="fa fa-check"></i><b>13.2</b> Time logging</a></li>
<li class="chapter" data-level="13.3" data-path="time.html"><a href="time.html#predict-total-runtime"><i class="fa fa-check"></i><b>13.3</b> Predict total runtime</a></li>
<li class="chapter" data-level="13.4" data-path="time.html"><a href="time.html#strategize-your-high-performance-computing"><i class="fa fa-check"></i><b>13.4</b> Strategize your high-performance computing</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="memory.html"><a href="memory.html"><i class="fa fa-check"></i><b>14</b> Memory management</a>
<ul>
<li class="chapter" data-level="14.1" data-path="memory.html"><a href="memory.html#garbage-collection-and-custom-files"><i class="fa fa-check"></i><b>14.1</b> Garbage collection and custom files</a></li>
<li class="chapter" data-level="14.2" data-path="memory.html"><a href="memory.html#memory-strategies"><i class="fa fa-check"></i><b>14.2</b> Memory strategies</a></li>
<li class="chapter" data-level="14.3" data-path="memory.html"><a href="memory.html#data-splitting"><i class="fa fa-check"></i><b>14.3</b> Data splitting</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="storage.html"><a href="storage.html"><i class="fa fa-check"></i><b>15</b> Storage</a>
<ul>
<li class="chapter" data-level="15.1" data-path="storage.html"><a href="storage.html#drakes-cache"><i class="fa fa-check"></i><b>15.1</b> <code>drake</code>’s cache</a></li>
<li class="chapter" data-level="15.2" data-path="storage.html"><a href="storage.html#efficient-target-storage"><i class="fa fa-check"></i><b>15.2</b> Efficient target storage</a></li>
<li class="chapter" data-level="15.3" data-path="storage.html"><a href="storage.html#why-is-my-cache-so-big"><i class="fa fa-check"></i><b>15.3</b> Why is my cache so big?</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="storage.html"><a href="storage.html#old-targets"><i class="fa fa-check"></i><b>15.3.1</b> Old targets</a></li>
<li class="chapter" data-level="15.3.2" data-path="storage.html"><a href="storage.html#garbage-from-interrupted-builds"><i class="fa fa-check"></i><b>15.3.2</b> Garbage from interrupted builds</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="storage.html"><a href="storage.html#interfaces-to-the-cache"><i class="fa fa-check"></i><b>15.4</b> Interfaces to the cache</a></li>
</ul></li>
<li class="part"><span><b>IV Extra features</b></span></li>
<li class="chapter" data-level="16" data-path="visuals.html"><a href="visuals.html"><i class="fa fa-check"></i><b>16</b> Visualization with drake</a>
<ul>
<li class="chapter" data-level="16.1" data-path="visuals.html"><a href="visuals.html#plotting-plans"><i class="fa fa-check"></i><b>16.1</b> Plotting plans</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="visuals.html"><a href="visuals.html#vis_drake_graph"><i class="fa fa-check"></i><b>16.1.1</b> <code>vis_drake_graph()</code></a></li>
<li class="chapter" data-level="16.1.2" data-path="visuals.html"><a href="visuals.html#sankey_drake_graph"><i class="fa fa-check"></i><b>16.1.2</b> <code>sankey_drake_graph()</code></a></li>
<li class="chapter" data-level="16.1.3" data-path="visuals.html"><a href="visuals.html#drake_ggraph"><i class="fa fa-check"></i><b>16.1.3</b> <code>drake_ggraph()</code></a></li>
<li class="chapter" data-level="16.1.4" data-path="visuals.html"><a href="visuals.html#text_drake_graph"><i class="fa fa-check"></i><b>16.1.4</b> <code>text_drake_graph()</code></a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="visuals.html"><a href="visuals.html#underlying-graph-data-node-and-edge-data-frames"><i class="fa fa-check"></i><b>16.2</b> Underlying graph data: node and edge data frames</a></li>
<li class="chapter" data-level="16.3" data-path="visuals.html"><a href="visuals.html#visualizing-target-status"><i class="fa fa-check"></i><b>16.3</b> Visualizing target status</a></li>
<li class="chapter" data-level="16.4" data-path="visuals.html"><a href="visuals.html#subgraphs"><i class="fa fa-check"></i><b>16.4</b> Subgraphs</a></li>
<li class="chapter" data-level="16.5" data-path="visuals.html"><a href="visuals.html#control-the-vis_drake_graph-legend."><i class="fa fa-check"></i><b>16.5</b> Control the <code>vis_drake_graph()</code> legend.</a></li>
<li class="chapter" data-level="16.6" data-path="visuals.html"><a href="visuals.html#clusters"><i class="fa fa-check"></i><b>16.6</b> Clusters</a></li>
<li class="chapter" data-level="16.7" data-path="visuals.html"><a href="visuals.html#output-files"><i class="fa fa-check"></i><b>16.7</b> Output files</a></li>
<li class="chapter" data-level="16.8" data-path="visuals.html"><a href="visuals.html#node-selection"><i class="fa fa-check"></i><b>16.8</b> Node Selection</a>
<ul>
<li class="chapter" data-level="16.8.1" data-path="visuals.html"><a href="visuals.html#perform-the-default-action-on-select"><i class="fa fa-check"></i><b>16.8.1</b> Perform the default action on select</a></li>
<li class="chapter" data-level="16.8.2" data-path="visuals.html"><a href="visuals.html#perform-no-action-on-select"><i class="fa fa-check"></i><b>16.8.2</b> Perform no action on select</a></li>
<li class="chapter" data-level="16.8.3" data-path="visuals.html"><a href="visuals.html#customize-the-onselect-event-behaviour"><i class="fa fa-check"></i><b>16.8.3</b> Customize the onSelect event behaviour</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="debugging.html"><a href="debugging.html"><i class="fa fa-check"></i><b>17</b> Debugging and testing drake projects</a>
<ul>
<li class="chapter" data-level="17.1" data-path="debugging.html"><a href="debugging.html#debugging-failed-targets"><i class="fa fa-check"></i><b>17.1</b> Debugging failed targets</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="debugging.html"><a href="debugging.html#diagnosing-errors"><i class="fa fa-check"></i><b>17.1.1</b> Diagnosing errors</a></li>
<li class="chapter" data-level="17.1.2" data-path="debugging.html"><a href="debugging.html#interactive-debugging"><i class="fa fa-check"></i><b>17.1.2</b> Interactive debugging</a></li>
<li class="chapter" data-level="17.1.3" data-path="debugging.html"><a href="debugging.html#efficient-trial-and-error"><i class="fa fa-check"></i><b>17.1.3</b> Efficient trial and error</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="debugging.html"><a href="debugging.html#why-do-my-targets-keep-rerunning"><i class="fa fa-check"></i><b>17.2</b> Why do my targets keep rerunning?</a>
<ul>
<li class="chapter" data-level="17.2.1" data-path="debugging.html"><a href="debugging.html#how-your-workflow-fits-together"><i class="fa fa-check"></i><b>17.2.1</b> How your workflow fits together</a></li>
<li class="chapter" data-level="17.2.2" data-path="debugging.html"><a href="debugging.html#which-targets-are-outdated"><i class="fa fa-check"></i><b>17.2.2</b> Which targets are outdated</a></li>
<li class="chapter" data-level="17.2.3" data-path="debugging.html"><a href="debugging.html#why-your-targets-are-outdated"><i class="fa fa-check"></i><b>17.2.3</b> Why your targets are outdated</a></li>
<li class="chapter" data-level="17.2.4" data-path="debugging.html"><a href="debugging.html#strategies-to-prevent-unexpected-changes-in-the-future"><i class="fa fa-check"></i><b>17.2.4</b> Strategies to prevent unexpected changes in the future</a></li>
</ul></li>
<li class="chapter" data-level="17.3" data-path="debugging.html"><a href="debugging.html#more-help"><i class="fa fa-check"></i><b>17.3</b> More help</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="triggers.html"><a href="triggers.html"><i class="fa fa-check"></i><b>18</b> Triggers: decision rules for building targets</a>
<ul>
<li class="chapter" data-level="18.1" data-path="triggers.html"><a href="triggers.html#what-are-triggers"><i class="fa fa-check"></i><b>18.1</b> What are triggers?</a></li>
<li class="chapter" data-level="18.2" data-path="triggers.html"><a href="triggers.html#customization"><i class="fa fa-check"></i><b>18.2</b> Customization</a></li>
<li class="chapter" data-level="18.3" data-path="triggers.html"><a href="triggers.html#alternative-trigger-modes"><i class="fa fa-check"></i><b>18.3</b> Alternative trigger modes</a></li>
<li class="chapter" data-level="18.4" data-path="triggers.html"><a href="triggers.html#a-more-practical-example"><i class="fa fa-check"></i><b>18.4</b> A more practical example</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="faq.html"><a href="faq.html"><i class="fa fa-check"></i><b>A</b> Frequently-asked questions</a></li>
<li class="chapter" data-level="B" data-path="design.html"><a href="design.html"><i class="fa fa-check"></i><b>B</b> Design</a>
<ul>
<li class="chapter" data-level="B.1" data-path="design.html"><a href="design.html#principles"><i class="fa fa-check"></i><b>B.1</b> Principles</a>
<ul>
<li class="chapter" data-level="B.1.1" data-path="design.html"><a href="design.html#functions-first"><i class="fa fa-check"></i><b>B.1.1</b> Functions first</a></li>
<li class="chapter" data-level="B.1.2" data-path="design.html"><a href="design.html#light-use-of-traditional-oop"><i class="fa fa-check"></i><b>B.1.2</b> Light use of traditional OOP</a></li>
<li class="chapter" data-level="B.1.3" data-path="design.html"><a href="design.html#high-performant-small-objects"><i class="fa fa-check"></i><b>B.1.3</b> High-performant small objects</a></li>
<li class="chapter" data-level="B.1.4" data-path="design.html"><a href="design.html#fast-iteration-along-aggregated-data"><i class="fa fa-check"></i><b>B.1.4</b> Fast iteration along aggregated data</a></li>
<li class="chapter" data-level="B.1.5" data-path="design.html"><a href="design.html#access-to-information-across-targets"><i class="fa fa-check"></i><b>B.1.5</b> Access to information across targets</a></li>
</ul></li>
<li class="chapter" data-level="B.2" data-path="design.html"><a href="design.html#specific-classes"><i class="fa fa-check"></i><b>B.2</b> Specific classes</a>
<ul>
<li class="chapter" data-level="B.2.1" data-path="design.html"><a href="design.html#config"><i class="fa fa-check"></i><b>B.2.1</b> Config</a></li>
<li class="chapter" data-level="B.2.2" data-path="design.html"><a href="design.html#settings"><i class="fa fa-check"></i><b>B.2.2</b> Settings</a></li>
<li class="chapter" data-level="B.2.3" data-path="churn.html"><a href="churn.html#plan"><i class="fa fa-check"></i><b>B.2.3</b> Plan</a></li>
<li class="chapter" data-level="B.2.4" data-path="design.html"><a href="design.html#specification"><i class="fa fa-check"></i><b>B.2.4</b> Specification</a></li>
<li class="chapter" data-level="B.2.5" data-path="design.html"><a href="design.html#graph"><i class="fa fa-check"></i><b>B.2.5</b> Graph</a></li>
<li class="chapter" data-level="B.2.6" data-path="design.html"><a href="design.html#priority-queue"><i class="fa fa-check"></i><b>B.2.6</b> Priority queue</a></li>
<li class="chapter" data-level="B.2.7" data-path="design.html"><a href="design.html#metadata"><i class="fa fa-check"></i><b>B.2.7</b> Metadata</a></li>
<li class="chapter" data-level="B.2.8" data-path="design.html"><a href="design.html#cache"><i class="fa fa-check"></i><b>B.2.8</b> Cache</a></li>
<li class="chapter" data-level="B.2.9" data-path="design.html"><a href="design.html#code-analysis-lists"><i class="fa fa-check"></i><b>B.2.9</b> Code analysis lists</a></li>
<li class="chapter" data-level="B.2.10" data-path="design.html"><a href="design.html#environments"><i class="fa fa-check"></i><b>B.2.10</b> Environments</a></li>
<li class="chapter" data-level="B.2.11" data-path="design.html"><a href="design.html#hash-tables"><i class="fa fa-check"></i><b>B.2.11</b> Hash tables</a></li>
<li class="chapter" data-level="B.2.12" data-path="design.html"><a href="design.html#logger"><i class="fa fa-check"></i><b>B.2.12</b> Logger</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The drake R Package User Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hpc" class="section level1" number="12">
<h1><span class="header-section-number">Chapter 12</span> High-performance computing</h1>
<p>This chapter provides guidance on time-consuming <code>drake</code> workflows and high-level parallel computation.</p>
<div id="start-small" class="section level2" number="12.1">
<h2><span class="header-section-number">12.1</span> Start small</h2>
<p>Before you jump into high-performance computing with a large workflow, consider running a downsized version to debug and test things first. That way, you can avoid consuming lots of computing resources until you are reasonably sure everything works. Create a test plan with <code>drake_plan(max_expand = SMALL_NUMBER)</code> before scaling up to the full set of targets, and take temporary shortcuts in your commands so your targets build more quickly for test mode. See <a href="https://books.ropensci.org/drake/static.html#start-small">this section on plans</a> for details.</p>
</div>
<div id="let-make-schedule-your-targets." class="section level2" number="12.2">
<h2><span class="header-section-number">12.2</span> Let <code>make()</code> schedule your targets.</h2>
<p>When it comes time to activate high-performance computing, <code>drake</code> launches its own parallel workers and sends targets to those workers. The workers can be local processes or jobs on a cluster. <code>drake</code> uses your project’s implicit dependency graph to figure out which targets can run in parallel and which ones need to wait for dependencies.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="hpc.html#cb180-1"></a><span class="kw">load_mtcars_example</span>() <span class="co"># from https://github.com/wlandau/drake-examples/tree/master/mtcars</span></span>
<span id="cb180-2"><a href="hpc.html#cb180-2"></a><span class="kw">vis_drake_graph</span>(my_plan)</span></code></pre></div>
<div id="htmlwidget-3a240aff0b10c84e3288" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-3a240aff0b10c84e3288">{"x":{"nodes":{"id":["n-NNXGS5DSHI5GW3TJOQ","p-OJSXA33SOQXFE3LE","reg1","reg2","random_rows","n-MRQXIYLTMV2HGOR2NV2GGYLSOM","simulate","large","small","regression2_large","regression1_large","regression1_small","regression2_small","summ_regression2_large","coef_regression2_large","summ_regression1_large","coef_regression1_large","coef_regression1_small","summ_regression1_small","coef_regression2_small","summ_regression2_small","report","p-OJSXA33SOQXG2ZA"],"imported":[true,true,true,true,true,true,true,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],"label":["knitr::knit","file report.Rmd","reg1","reg2","random_rows","datasets::mtcars","simulate","large","small","regression2_large","regression1_large","regression1_small","regression2_small","summ_regression2_large","coef_regression2_large","summ_regression1_large","coef_regression1_large","coef_regression1_small","summ_regression1_small","coef_regression2_small","summ_regression2_small","report","file report.md"],"status":["imported","imported","imported","imported","imported","imported","imported","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["function","file","function","function","function","object","function","object","object","object","object","object","object","object","object","object","object","object","object","object","object","object","file"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],"color":["#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["triangle","square","triangle","triangle","triangle","dot","triangle","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","square"],"level":[1,1,1,1,1,1,2,3,3,4,4,4,4,5,5,5,5,5,5,5,5,6,7],"x":[-1,-1,-1,-1,-1,-1,-0.666666666666667,-0.333333333333333,-0.333333333333333,0,0,0,0,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.666666666666667,1],"y":[-0.918367346938776,-0.551020408163265,-0.183673469387755,0.183673469387755,0.551020408163265,0.918367346938776,2.22044604925031e-16,-0.428571428571428,0.428571428571429,-0.771428571428571,-0.257142857142857,0.257142857142858,0.771428571428572,-1,-0.714285714285714,-0.428571428571428,-0.142857142857143,0.142857142857143,0.428571428571429,0.714285714285714,1,2.22044604925031e-16,2.22044604925031e-16]},"edges":{"from":["n-NNXGS5DSHI5GW3TJOQ","large","large","large","small","small","small","coef_regression2_small","p-OJSXA33SOQXFE3LE","report","reg1","reg1","regression2_large","regression2_large","reg2","reg2","simulate","simulate","regression1_large","regression1_large","random_rows","n-MRQXIYLTMV2HGOR2NV2GGYLSOM","regression1_small","regression1_small","regression2_small","regression2_small"],"to":["report","report","regression2_large","regression1_large","report","regression1_small","regression2_small","report","report","p-OJSXA33SOQXG2ZA","regression1_large","regression1_small","summ_regression2_large","coef_regression2_large","regression2_large","regression2_small","large","small","summ_regression1_large","coef_regression1_large","simulate","simulate","coef_regression1_small","summ_regression1_small","coef_regression2_small","summ_regression2_small"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"interaction":{"navigationButtons":true},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function","File"],"color":["#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[2,6,8,10,11]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>You do not need to not micromanage how targets are scheduled, and you do not need to run simultaneous instances of <code>make()</code>.</p>
</div>
<div id="the-master-process" class="section level2" number="12.3">
<h2><span class="header-section-number">12.3</span> The master process</h2>
<p><code>make()</code> takes care of the jobs it launches, but <code>make()</code> <em>itself</em> is a job too, and it is your responsibility to manage it.</p>
<div id="master-on-a-cluster" class="section level3" number="12.3.1">
<h3><span class="header-section-number">12.3.1</span> Master on a cluster</h3>
<p>Most clusters will let you submit <code>make()</code> as a job on a compute node. Let’s consider the Sun Grid Engine (SGE) as an example. First, we create a script that calls <code>make()</code> (or <a href="https://docs.ropensci.org/drake/reference/r_make.html"><code>r_make()</code></a>).</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="hpc.html#cb181-1"></a><span class="co"># make.R</span></span>
<span id="cb181-2"><a href="hpc.html#cb181-2"></a><span class="kw">source</span>(<span class="st">&quot;R/packages.R&quot;</span>)</span>
<span id="cb181-3"><a href="hpc.html#cb181-3"></a><span class="kw">source</span>(<span class="st">&quot;R/packages.R&quot;</span>)</span>
<span id="cb181-4"><a href="hpc.html#cb181-4"></a><span class="kw">source</span>(<span class="st">&quot;R/packages.R&quot;</span>)</span>
<span id="cb181-5"><a href="hpc.html#cb181-5"></a><span class="kw">options</span>(</span>
<span id="cb181-6"><a href="hpc.html#cb181-6"></a>  <span class="dt">clustermq.scheduler =</span> <span class="st">&quot;sge&quot;</span>,</span>
<span id="cb181-7"><a href="hpc.html#cb181-7"></a>  <span class="co"># Created by drake_hpc_template_file(&quot;sge_clustermq.tmpl&quot;):</span></span>
<span id="cb181-8"><a href="hpc.html#cb181-8"></a>  <span class="dt">clustermq.template =</span> <span class="st">&quot;sge_clustermq.tmpl&quot;</span></span>
<span id="cb181-9"><a href="hpc.html#cb181-9"></a>)</span>
<span id="cb181-10"><a href="hpc.html#cb181-10"></a><span class="kw">make</span>(</span>
<span id="cb181-11"><a href="hpc.html#cb181-11"></a>  plan,</span>
<span id="cb181-12"><a href="hpc.html#cb181-12"></a>  <span class="dt">parallelism =</span> <span class="st">&quot;clustermq&quot;</span>,</span>
<span id="cb181-13"><a href="hpc.html#cb181-13"></a>  <span class="dt">jobs =</span> <span class="dv">8</span>,</span>
<span id="cb181-14"><a href="hpc.html#cb181-14"></a>  <span class="dt">console_log_file =</span> <span class="st">&quot;drake.log&quot;</span></span>
<span id="cb181-15"><a href="hpc.html#cb181-15"></a>)</span></code></pre></div>
<p>Then, we create a shell script (say, <code>run.sh</code>) to call <code>make.R</code>. This script may look different if you use a different scheduler such as <a href="https://slurm.schedmd.com">SLURM</a>.</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb182-1"><a href="hpc.html#cb182-1"></a><span class="co"># run.sh</span></span>
<span id="cb182-2"><a href="hpc.html#cb182-2"></a><span class="co">#!/bin/bash</span></span>
<span id="cb182-3"><a href="hpc.html#cb182-3"></a><span class="co">#$ -j y       # combine stdout/error in one file</span></span>
<span id="cb182-4"><a href="hpc.html#cb182-4"></a><span class="co">#$ -o log.out # output file</span></span>
<span id="cb182-5"><a href="hpc.html#cb182-5"></a><span class="co">#$ -cwd       # use pwd as work dir</span></span>
<span id="cb182-6"><a href="hpc.html#cb182-6"></a><span class="co">#$ -V         # use environment variable</span></span>
<span id="cb182-7"><a href="hpc.html#cb182-7"></a><span class="ex">module</span> load R <span class="co"># Uncomment if R is an environment module.</span></span>
<span id="cb182-8"><a href="hpc.html#cb182-8"></a><span class="ex">R</span> --no-save CMD BATCH make.R</span></code></pre></div>
<p>Finally, to run the whole workflow, we call <code>qsub</code>.</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb183-1"><a href="hpc.html#cb183-1"></a><span class="ex">qsub</span> run.sh</span></code></pre></div>
<p>And here is what happens:</p>
<ol style="list-style-type: decimal">
<li>A new job starts on the cluster with the configuration flags next to <code>#$</code> in <code>run.sh</code>.</li>
<li><code>run.sh</code> opens R and runs <code>make.R</code>.</li>
<li><code>make.R</code> invokes <code>drake</code> using the <code>make()</code> function.</li>
<li><code>make()</code> launches 8 new jobs on the cluster</li>
</ol>
<p>So 9 simultaneous jobs run on the cluster and we avoid bothering the headnode / login node.</p>
</div>
<div id="local-master" class="section level3" number="12.3.2">
<h3><span class="header-section-number">12.3.2</span> Local master</h3>
<p>Alternatively, you can run <code>make()</code> in a persistent background process. The following should work in the Mac/Linux terminal/shell.</p>
<pre><code>nohup nice -19 R --no-save CMD BATCH make.R &
</code></pre>
<p>where:</p>
<ul>
<li><code>nohup</code>: Keep the job running even if you log out of the machine.</li>
<li><code>nice -19</code>: This is a low-priority job that should not consume many resources. Other processes should take priority.</li>
<li><code>R CMD BATCH</code>: Run the R script in a fresh new R session.</li>
<li><code>--no-save</code>: do not save the workspace in a <code>.RData</code> file.</li>
<li><code>&amp;</code>: Run this job in the background so you can do other stuff in the terminal window.</li>
</ul>
<p>Alternatives to <code>nohup</code> include <a href="https://linuxize.com/post/how-to-use-linux-screen/"><code>screen</code></a> and <a href="http://byobu.co/">Byobu</a>.</p>
</div>
</div>
<div id="parallel-backends" class="section level2" number="12.4">
<h2><span class="header-section-number">12.4</span> Parallel backends</h2>
<p>Choose the parallel backend with the <code>parallelism</code> argument and set the <code>jobs</code> argument to scale the work appropriately.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="hpc.html#cb184-1"></a><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>The two primary backends with long term support are <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a> and <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a>. If you can install <a href="http://zeromq.org">ZeroMQ</a>, the best choice is usually <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a>. (It is faster than <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a>.) However, <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> is more accessible: it does not require <a href="http://zeromq.org">ZeroMQ</a>, it supports parallel computing on Windows, it can work with more restrictive wall time limits on clusters, and it <a href="https://github.com/wlandau/drake-examples/tree/master/Docker-psock">can deploy targets to Docker images</a> (<code>drake_example("Docker-psock")</code>).</p>
</div>
<div id="the-clustermq-backend" class="section level2" number="12.5">
<h2><span class="header-section-number">12.5</span> The <code>clustermq</code> backend</h2>
<div id="persistent-workers" class="section level3" number="12.5.1">
<h3><span class="header-section-number">12.5.1</span> Persistent workers</h3>
<p>The <code>make(parallelism = "clustermq", jobs = 2)</code> launches 2 parallel <em>persistent workers</em>. The master process assigns targets to workers, and the workers simultaneously traverse the dependency graph.</p>
<script src="https://fast.wistia.com/embed/medias/ycczhxwkjw.jsonp" async></script>
<script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="wistia_responsive_padding" style="padding:56.21% 0 0 0;position:relative;">
<div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
<div class="wistia_embed wistia_async_ycczhxwkjw videoFoam=true" style="height:100%;position:relative;width:100%">
<div class="wistia_swatch" style="height:100%;left:0;opacity:0;overflow:hidden;position:absolute;top:0;transition:opacity 200ms;width:100%;">
<img src="https://fast.wistia.com/embed/medias/ycczhxwkjw/swatch" style="filter:blur(5px);height:100%;object-fit:contain;width:100%;" alt="" onload="this.parentNode.style.opacity=1;" />
</div>
</div>
</div>
</div>
</div>
<div id="installation" class="section level3" number="12.5.2">
<h3><span class="header-section-number">12.5.2</span> Installation</h3>
<p>Persistent workers require the <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a> R package, which in turn requires <a href="http://zeromq.org/">ZeroMQ</a>. Please refer to the <a href="https://github.com/mschubert/clustermq/blob/master/README.md#installation"><code>clustermq</code> installation guide</a> for specific instructions.</p>
</div>
<div id="on-your-local-machine" class="section level3" number="12.5.3">
<h3><span class="header-section-number">12.5.3</span> On your local machine</h3>
<p>To run your targets in parallel over the cores of your local machine, set the global option below and run <code>make()</code>.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="hpc.html#cb185-1"></a><span class="kw">options</span>(<span class="dt">clustermq.scheduler =</span> <span class="st">&quot;multicore&quot;</span>)</span>
<span id="cb185-2"><a href="hpc.html#cb185-2"></a><span class="kw">make</span>(plan, <span class="dt">parallelism =</span> <span class="st">&quot;clustermq&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="on-a-cluster" class="section level3" number="12.5.4">
<h3><span class="header-section-number">12.5.4</span> On a cluster</h3>
<p>Set the <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a> global options to register your computing resources. For <a href="https://slurm.schedmd.com/slurmd.html">SLURM</a>:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="hpc.html#cb186-1"></a><span class="kw">options</span>(<span class="dt">clustermq.scheduler =</span> <span class="st">&quot;slurm&quot;</span>, <span class="dt">clustermq.template =</span> <span class="st">&quot;slurm_clustermq.tmpl&quot;</span>)</span></code></pre></div>
<p>Here, <code>slurm_clustermq.tmpl</code> is a <a href="https://github.com/ropensci/drake/tree/master/inst/templates/hpc">template file</a> with configuration details. Use <code>drake_hpc_template_file()</code> to write one of the available examples.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="hpc.html#cb187-1"></a><span class="kw">drake_hpc_template_file</span>(<span class="st">&quot;slurm_clustermq.tmpl&quot;</span>) <span class="co"># Write the file slurm_clustermq.tmpl.</span></span></code></pre></div>
<p>After modifying <code>slurm_clustermq.tmpl</code> by hand to meet your needs, call <code>make()</code> as usual.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="hpc.html#cb188-1"></a><span class="kw">make</span>(plan, <span class="dt">parallelism =</span> <span class="st">&quot;clustermq&quot;</span>, <span class="dt">jobs =</span> <span class="dv">4</span>)</span></code></pre></div>
</div>
</div>
<div id="the-future-backend" class="section level2" number="12.6">
<h2><span class="header-section-number">12.6</span> The <code>future</code> backend</h2>
<div id="transient-workers" class="section level3" number="12.6.1">
<h3><span class="header-section-number">12.6.1</span> Transient workers</h3>
<p><code>make(parallelism = "future", jobs = 2)</code> launches <em>transient workers</em> to build your targets. When a target is ready to build, the master process creates a fresh worker to build it, and the worker terminates when the target is done. <code>jobs = 2</code> means that at most 2 transient workers are allowed to run at a given time.</p>
<script src="https://fast.wistia.com/embed/medias/340yvlp515.jsonp" async></script>
<script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="wistia_responsive_padding" style="padding:56.21% 0 0 0;position:relative;">
<div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
<div class="wistia_embed wistia_async_340yvlp515 videoFoam=true" style="height:100%;position:relative;width:100%">
<div class="wistia_swatch" style="height:100%;left:0;opacity:0;overflow:hidden;position:absolute;top:0;transition:opacity 200ms;width:100%;">
<img src="https://fast.wistia.com/embed/medias/340yvlp515/swatch" style="filter:blur(5px);height:100%;object-fit:contain;width:100%;" alt="" onload="this.parentNode.style.opacity=1;" />
</div>
</div>
</div>
</div>
<p><br></p>
</div>
<div id="installation-1" class="section level3" number="12.6.2">
<h3><span class="header-section-number">12.6.2</span> Installation</h3>
<p>Install the <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> package.</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="hpc.html#cb189-1"></a><span class="kw">install.packages</span>(<span class="st">&quot;future&quot;</span>) <span class="co"># CRAN release</span></span>
<span id="cb189-2"><a href="hpc.html#cb189-2"></a><span class="co"># Alternatively, install the GitHub development version.</span></span>
<span id="cb189-3"><a href="hpc.html#cb189-3"></a>devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;HenrikBengtsson/future&quot;</span>, <span class="dt">ref =</span> <span class="st">&quot;develop&quot;</span>)</span></code></pre></div>
<p>If you intend to use a cluster, be sure to install the <a href="https://github.com/HenrikBengtsson/future.batchtools"><code>future.batchtools</code></a> package too. The <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> ecosystem contains even more packages that extend <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a>’s parallel computing functionality, such as <a href="https://github.com/HenrikBengtsson/future.callr"><code>future.callr</code></a>.</p>
</div>
<div id="on-your-local-machine-1" class="section level3" number="12.6.3">
<h3><span class="header-section-number">12.6.3</span> On your local machine</h3>
<p>First, select a <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> plan to tell <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> how to create the workers. See <a href="https://github.com/HenrikBengtsson/future#controlling-how-futures-are-resolved">this table</a> for descriptions of the core options.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="hpc.html#cb190-1"></a>future<span class="op">::</span><span class="kw">plan</span>(future<span class="op">::</span>multiprocess) </span></code></pre></div>
<p>Next, run <code>make()</code>.</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="hpc.html#cb191-1"></a><span class="kw">make</span>(plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="on-a-cluster-1" class="section level3" number="12.6.4">
<h3><span class="header-section-number">12.6.4</span> On a cluster</h3>
<p>Install the <a href="https://github.com/HenrikBengtsson/future.batchtools"><code>future.batchtools</code></a> package and use <a href="https://github.com/HenrikBengtsson/future.batchtools#choosing-batchtools-backend">this list</a> to select a <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> plan that matches your resources. You will also need a compatible <a href="https://github.com/mllg/batchtools/tree/master/inst/templates">template file</a> with configuration details. As with <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a>, <code>drake</code> can generate some examples:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="hpc.html#cb192-1"></a><span class="kw">drake_hpc_template_file</span>(<span class="st">&quot;slurm_batchtools.tmpl&quot;</span>) <span class="co"># Edit by hand.</span></span></code></pre></div>
<p>Next, register the template file with a plan.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="hpc.html#cb193-1"></a><span class="kw">library</span>(future.batchtools)</span>
<span id="cb193-2"><a href="hpc.html#cb193-2"></a>future<span class="op">::</span><span class="kw">plan</span>(batchtools_slurm, <span class="dt">template =</span> <span class="st">&quot;slurm_batchtools.tmpl&quot;</span>)</span></code></pre></div>
<p>Finally, run <code>make()</code>.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="hpc.html#cb194-1"></a><span class="kw">make</span>(plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
</div>
<div id="advanced-options" class="section level2" number="12.7">
<h2><span class="header-section-number">12.7</span> Advanced options</h2>
<div id="selectivity" class="section level3" number="12.7.1">
<h3><span class="header-section-number">12.7.1</span> Selectivity</h3>
<p>Some targets build so quickly that it is not worth sending them to parallel workers. To run these targets locally in the master process, define a special <code>hpc</code> column of your <code>drake</code> plan. Below, <code>NA</code> and <code>TRUE</code> are treated the same, and <code>make(plan, parallelism = "clustermq")</code> only sends <code>model_1</code> and <code>model_2</code> to parallel workers.</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="hpc.html#cb195-1"></a><span class="kw">drake_plan</span>(</span>
<span id="cb195-2"><a href="hpc.html#cb195-2"></a>  <span class="dt">model =</span> <span class="kw">target</span>(</span>
<span id="cb195-3"><a href="hpc.html#cb195-3"></a>    <span class="kw">crazy_long_computation</span>(index),</span>
<span id="cb195-4"><a href="hpc.html#cb195-4"></a>    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">index =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb195-5"><a href="hpc.html#cb195-5"></a>  ),</span>
<span id="cb195-6"><a href="hpc.html#cb195-6"></a>  <span class="dt">accuracy =</span> <span class="kw">target</span>(</span>
<span id="cb195-7"><a href="hpc.html#cb195-7"></a>    <span class="kw">summarize_accuracy</span>(model),</span>
<span id="cb195-8"><a href="hpc.html#cb195-8"></a>    <span class="dt">transform =</span> <span class="kw">combine</span>(model),</span>
<span id="cb195-9"><a href="hpc.html#cb195-9"></a>    <span class="dt">hpc =</span> <span class="ot">FALSE</span></span>
<span id="cb195-10"><a href="hpc.html#cb195-10"></a>  ),</span>
<span id="cb195-11"><a href="hpc.html#cb195-11"></a>  <span class="dt">specificity =</span> <span class="kw">target</span>(</span>
<span id="cb195-12"><a href="hpc.html#cb195-12"></a>    <span class="kw">summarize_specificity</span>(model),</span>
<span id="cb195-13"><a href="hpc.html#cb195-13"></a>    <span class="dt">transform =</span> <span class="kw">combine</span>(model),</span>
<span id="cb195-14"><a href="hpc.html#cb195-14"></a>    <span class="dt">hpc =</span> <span class="ot">FALSE</span></span>
<span id="cb195-15"><a href="hpc.html#cb195-15"></a>  ),</span>
<span id="cb195-16"><a href="hpc.html#cb195-16"></a>  <span class="dt">report =</span> <span class="kw">target</span>(</span>
<span id="cb195-17"><a href="hpc.html#cb195-17"></a>    <span class="kw">render</span>(<span class="kw">knitr_in</span>(<span class="st">&quot;results.Rmd&quot;</span>), <span class="dt">output_file =</span> <span class="kw">file_out</span>(<span class="st">&quot;results.html&quot;</span>)),</span>
<span id="cb195-18"><a href="hpc.html#cb195-18"></a>    <span class="dt">hpc =</span> <span class="ot">FALSE</span></span>
<span id="cb195-19"><a href="hpc.html#cb195-19"></a>  )</span>
<span id="cb195-20"><a href="hpc.html#cb195-20"></a>)</span>
<span id="cb195-21"><a href="hpc.html#cb195-21"></a><span class="co">#&gt; # A tibble: 5 x 3</span></span>
<span id="cb195-22"><a href="hpc.html#cb195-22"></a><span class="co">#&gt;   target      command                                                      hpc  </span></span>
<span id="cb195-23"><a href="hpc.html#cb195-23"></a><span class="co">#&gt;   &lt;chr&gt;       &lt;expr_lst&gt;                                                   &lt;lgl&gt;</span></span>
<span id="cb195-24"><a href="hpc.html#cb195-24"></a><span class="co">#&gt; 1 accuracy    summarize_accuracy(model_1, model_2)                       … FALSE</span></span>
<span id="cb195-25"><a href="hpc.html#cb195-25"></a><span class="co">#&gt; 2 model_1     crazy_long_computation(1)                                  … NA   </span></span>
<span id="cb195-26"><a href="hpc.html#cb195-26"></a><span class="co">#&gt; 3 model_2     crazy_long_computation(2)                                  … NA   </span></span>
<span id="cb195-27"><a href="hpc.html#cb195-27"></a><span class="co">#&gt; 4 report      render(knitr_in(&quot;results.Rmd&quot;), output_file = file_out(&quot;res… FALSE</span></span>
<span id="cb195-28"><a href="hpc.html#cb195-28"></a><span class="co">#&gt; 5 specificity summarize_specificity(model_1, model_2)                    … FALSE</span></span></code></pre></div>
</div>
<div id="memory-options" class="section level3" number="12.7.2">
<h3><span class="header-section-number">12.7.2</span> Memory options</h3>
<p>By default, <code>make()</code> keeps targets in memory during runtime. Some targets are dependencies of other targets downstream, while others may be no longer actually need to be in memory. The <code>memory_strategy</code> argument to <code>make()</code> allows you to choose the tradeoff that best suits your project. Options:</p>
<ul>
<li><code>"speed"</code>: Once a target is loaded in memory, just keep it there. This choice maximizes speed and hogs memory.</li>
<li><code>"memory"</code>: Just before building each new target, unload everything from memory except the target’s direct dependencies. This option conserves memory, but it sacrifices speed because each new target needs to reload any previously unloaded targets from storage.</li>
<li><code>"lookahead"</code>: Just before building each new target, search the dependency graph to find targets that will not be needed for the rest of the current <code>make()</code> session. In this mode, targets are only in memory if they need to be loaded, and we avoid superfluous reads from the cache. However, searching the graph takes time, and it could even double the computational overhead for large projects.</li>
</ul>
</div>
<div id="storage-options" class="section level3" number="12.7.3">
<h3><span class="header-section-number">12.7.3</span> Storage options</h3>
<p>In <code>make(caching = "master")</code>, the workers send the targets to the master process, and the master process stores them one by one in the cache. <code>caching = "master"</code> is compatible with all <a href="https://github.com/richfitz/storr"><code>storr</code></a> cache formats, including the more esoteric ones like <code>storr_dbi()</code> and <code>storr_environment()</code>.</p>
<p>In <code>make(caching = "worker")</code>, the parallel workers are responsible for writing the targets to the cache. Some output-heavy projects can benefit from this form of parallelism. However, it can sometimes add slowness on clusters due to lag from network file systems. And there are additional restrictions:</p>
<ul>
<li>All the workers must have the same file system and the same working directory as the master process.</li>
<li>Only the default <code>storr_rds()</code> cache may be used. Other formats like <code>storr_dbi()</code> and <code>storr_environment()</code> cannot accommodate parallel cache operations.</li>
</ul>
<p>See the <a href="storage.html#storage">storage chapter</a> for details.</p>
</div>
<div id="the-template-argument-for-persistent-workers" class="section level3" number="12.7.4">
<h3><span class="header-section-number">12.7.4</span> The <code>template</code> argument for persistent workers</h3>
<p>For more control and flexibility in the <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a> backend, you can parameterize your template file and use the <code>template</code> argument of <code>make()</code>. For example, suppose you want to programatically set the number of “slots” (basically cores) per job on an <a href="http://gridscheduler.sourceforge.net/htmlman/manuals.html">SGE system</a> (<code>clustermq</code> guide to SGE setup <a href="https://github.com/mschubert/clustermq/wiki/SGE">here</a>). Begin with a parameterized template file <code>sge_clustermq.tmpl</code> with a custom <code>n_slots</code> placeholder.</p>
<pre><code># File: sge_clustermq.tmpl
# Modified from https://github.com/mschubert/clustermq/wiki/SGE
#$ -N {{ job_name }}               # job name
#$ -t 1-{{ n_jobs }}               # submit jobs as array
#$ -j y                            # combine stdout/error in one file
#$ -o {{ log_file | /dev/null }}   # output file
#$ -cwd                            # use pwd as work dir
#$ -V                              # use environment variable
#$ -pe smp {{ n_slots | 1 }}       # request n_slots cores per job
module load R
ulimit -v $(( 1024 * {{ memory | 4096 }} ))
CMQ_AUTH={{ auth }} R --no-save --no-restore -e &#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</code></pre>
<p>Then when you run <code>make()</code>, use the <code>template</code> argument to set <code>n_slots</code>.</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="hpc.html#cb197-1"></a><span class="kw">options</span>(<span class="dt">clustermq.scheduler =</span> <span class="st">&quot;sge&quot;</span>, <span class="dt">clustermq.template =</span> <span class="st">&quot;sge_clustermq.tmpl&quot;</span>)</span>
<span id="cb197-2"><a href="hpc.html#cb197-2"></a><span class="kw">library</span>(drake)</span>
<span id="cb197-3"><a href="hpc.html#cb197-3"></a><span class="kw">load_mtcars_example</span>()</span>
<span id="cb197-4"><a href="hpc.html#cb197-4"></a><span class="kw">make</span>(</span>
<span id="cb197-5"><a href="hpc.html#cb197-5"></a>  my_plan,</span>
<span id="cb197-6"><a href="hpc.html#cb197-6"></a>  <span class="dt">parallelism =</span> <span class="st">&quot;clustermq&quot;</span>,</span>
<span id="cb197-7"><a href="hpc.html#cb197-7"></a>  <span class="dt">jobs =</span> <span class="dv">16</span>,</span>
<span id="cb197-8"><a href="hpc.html#cb197-8"></a>  <span class="dt">template =</span> <span class="kw">list</span>(<span class="dt">n_slots =</span> <span class="dv">4</span>) <span class="co"># Request 4 cores per persistent worker.</span></span>
<span id="cb197-9"><a href="hpc.html#cb197-9"></a>)</span></code></pre></div>
<p>Custom placeholders like <code>n_slots</code> are processed with the <a href="https://github.com/Bart6114/infuser"><code>infuser</code></a> package.</p>
</div>
<div id="the-resources-column-for-transient-workers" class="section level3" number="12.7.5">
<h3><span class="header-section-number">12.7.5</span> The <code>resources</code> column for transient workers</h3>
<p>Different targets may need different resources. For example,</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="hpc.html#cb198-1"></a>plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(</span>
<span id="cb198-2"><a href="hpc.html#cb198-2"></a>  <span class="dt">data =</span> <span class="kw">download_data</span>(),</span>
<span id="cb198-3"><a href="hpc.html#cb198-3"></a>  <span class="dt">model =</span> <span class="kw">big_machine_learning_model</span>(data)</span>
<span id="cb198-4"><a href="hpc.html#cb198-4"></a>)</span></code></pre></div>
<p>The <code>model</code> needs a GPU and multiple CPU cores, and the <code>data</code> only needs the bare minimum resources. Declare these requirements with <code>target()</code>, as below. This is equivalent to adding a new list column to the <code>plan</code>, where each element is a named list for the <code>resources</code> argument of <code>future::future()</code>.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="hpc.html#cb199-1"></a>plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(</span>
<span id="cb199-2"><a href="hpc.html#cb199-2"></a>  <span class="dt">data =</span> <span class="kw">target</span>(</span>
<span id="cb199-3"><a href="hpc.html#cb199-3"></a>    <span class="kw">download_data</span>(),</span>
<span id="cb199-4"><a href="hpc.html#cb199-4"></a>    <span class="dt">resources =</span> <span class="kw">list</span>(<span class="dt">cores =</span> <span class="dv">1</span>, <span class="dt">gpus =</span> <span class="dv">0</span>)</span>
<span id="cb199-5"><a href="hpc.html#cb199-5"></a>  ),</span>
<span id="cb199-6"><a href="hpc.html#cb199-6"></a>  <span class="dt">model =</span> <span class="kw">target</span>(</span>
<span id="cb199-7"><a href="hpc.html#cb199-7"></a>    <span class="kw">big_machine_learning_model</span>(data),</span>
<span id="cb199-8"><a href="hpc.html#cb199-8"></a>    <span class="dt">resources =</span> <span class="kw">list</span>(<span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">gpus =</span> <span class="dv">1</span>)</span>
<span id="cb199-9"><a href="hpc.html#cb199-9"></a>  )</span>
<span id="cb199-10"><a href="hpc.html#cb199-10"></a>)</span>
<span id="cb199-11"><a href="hpc.html#cb199-11"></a></span>
<span id="cb199-12"><a href="hpc.html#cb199-12"></a>plan</span>
<span id="cb199-13"><a href="hpc.html#cb199-13"></a><span class="co">#&gt; # A tibble: 2 x 3</span></span>
<span id="cb199-14"><a href="hpc.html#cb199-14"></a><span class="co">#&gt;   target command                          resources       </span></span>
<span id="cb199-15"><a href="hpc.html#cb199-15"></a><span class="co">#&gt;   &lt;chr&gt;  &lt;expr_lst&gt;                       &lt;list&gt;          </span></span>
<span id="cb199-16"><a href="hpc.html#cb199-16"></a><span class="co">#&gt; 1 data   download_data()                  &lt;named list [2]&gt;</span></span>
<span id="cb199-17"><a href="hpc.html#cb199-17"></a><span class="co">#&gt; 2 model  big_machine_learning_model(data) &lt;named list [2]&gt;</span></span>
<span id="cb199-18"><a href="hpc.html#cb199-18"></a></span>
<span id="cb199-19"><a href="hpc.html#cb199-19"></a><span class="kw">str</span>(plan<span class="op">$</span>resources)</span>
<span id="cb199-20"><a href="hpc.html#cb199-20"></a><span class="co">#&gt; List of 2</span></span>
<span id="cb199-21"><a href="hpc.html#cb199-21"></a><span class="co">#&gt;  $ :List of 2</span></span>
<span id="cb199-22"><a href="hpc.html#cb199-22"></a><span class="co">#&gt;   ..$ cores: num 1</span></span>
<span id="cb199-23"><a href="hpc.html#cb199-23"></a><span class="co">#&gt;   ..$ gpus : num 0</span></span>
<span id="cb199-24"><a href="hpc.html#cb199-24"></a><span class="co">#&gt;  $ :List of 2</span></span>
<span id="cb199-25"><a href="hpc.html#cb199-25"></a><span class="co">#&gt;   ..$ cores: num 4</span></span>
<span id="cb199-26"><a href="hpc.html#cb199-26"></a><span class="co">#&gt;   ..$ gpus : num 1</span></span></code></pre></div>
<p>Next, plug the names of your resources into the <a href="https://CRAN.R-project.org/package=brew"><code>brew</code></a> patterns of your <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> template file. The following <code>sge_batchtools.tmpl</code> file shows how to do it, but the file itself probably requires modification before it will work with your own machine.</p>
<pre><code>#!/bin/bash
#$ -cwd
#$ -j y
#$ -o &lt;%= log.file %&gt;
#$ -V
#$ -N &lt;%= job.name %&gt;
#$ -pe smp &lt;%= resources[[&quot;cores&quot;]] %&gt; # CPU cores
#$ -l gpu=&lt;%= resources[[&quot;gpus&quot;]] %&gt;   # GPUs.
Rscript -e &#39;batchtools::doJobCollection(&quot;&lt;%= uri %&gt;&quot;)&#39;
exit 0</code></pre>
<p>Finally, register the template file and run your project.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="hpc.html#cb201-1"></a><span class="kw">library</span>(drake)</span>
<span id="cb201-2"><a href="hpc.html#cb201-2"></a><span class="kw">library</span>(future.batchtools)</span>
<span id="cb201-3"><a href="hpc.html#cb201-3"></a>future<span class="op">::</span><span class="kw">plan</span>(batchtools_sge, <span class="dt">template =</span> <span class="st">&quot;sge_batchtools.tmpl&quot;</span>)</span>
<span id="cb201-4"><a href="hpc.html#cb201-4"></a><span class="kw">make</span>(plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="parallel-computing-within-targets" class="section level3" number="12.7.6">
<h3><span class="header-section-number">12.7.6</span> Parallel computing <em>within</em> targets</h3>
<p>To recruit parallel processes within individual targets, we recommend the <a href="https://github.com/HenrikBengtsson/future.callr"><code>future.callr</code></a> and <a href="https://github.com/DavisVaughan/furrr"><code>furrr</code></a> packages. Usage details depend on the parallel backend you choose for <code>make()</code>. If you must write custom code with <code>mclapply()</code>, please read the subsection below on locked bindings/environments.</p>
<div id="locally" class="section level4" number="12.7.6.1">
<h4><span class="header-section-number">12.7.6.1</span> Locally</h4>
<p>Use <a href="https://github.com/HenrikBengtsson/future.callr"><code>future.callr</code></a> and <a href="https://github.com/DavisVaughan/furrr"><code>furrr</code></a> normally.</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="hpc.html#cb202-1"></a><span class="kw">library</span>(drake)</span>
<span id="cb202-2"><a href="hpc.html#cb202-2"></a></span>
<span id="cb202-3"><a href="hpc.html#cb202-3"></a><span class="co"># The targets just collect the process IDs of the callr processes.</span></span>
<span id="cb202-4"><a href="hpc.html#cb202-4"></a>plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(</span>
<span id="cb202-5"><a href="hpc.html#cb202-5"></a>  <span class="dt">x =</span> furrr<span class="op">::</span><span class="kw">future_map_int</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>()),</span>
<span id="cb202-6"><a href="hpc.html#cb202-6"></a>  <span class="dt">y =</span> furrr<span class="op">::</span><span class="kw">future_map_int</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>())</span>
<span id="cb202-7"><a href="hpc.html#cb202-7"></a>)</span>
<span id="cb202-8"><a href="hpc.html#cb202-8"></a></span>
<span id="cb202-9"><a href="hpc.html#cb202-9"></a><span class="co"># Tell the drake targets to fork up to 4 callr processes.</span></span>
<span id="cb202-10"><a href="hpc.html#cb202-10"></a>future<span class="op">::</span><span class="kw">plan</span>(future.callr<span class="op">::</span>callr)</span>
<span id="cb202-11"><a href="hpc.html#cb202-11"></a></span>
<span id="cb202-12"><a href="hpc.html#cb202-12"></a><span class="co"># Build the targets.</span></span>
<span id="cb202-13"><a href="hpc.html#cb202-13"></a><span class="kw">make</span>(plan)</span>
<span id="cb202-14"><a href="hpc.html#cb202-14"></a></span>
<span id="cb202-15"><a href="hpc.html#cb202-15"></a><span class="co"># Process IDs of the local workers of x:</span></span>
<span id="cb202-16"><a href="hpc.html#cb202-16"></a><span class="kw">readd</span>(x)</span></code></pre></div>
</div>
<div id="persistent-workers-1" class="section level4" number="12.7.6.2">
<h4><span class="header-section-number">12.7.6.2</span> Persistent workers</h4>
<p>Each persistent worker needs its own <a href="https://github.com/HenrikBengtsson/future"><code>future::plan()</code></a>, which we set with the <code>prework</code> argument of <code>make()</code>. The following example uses <a href="http://gridscheduler.sourceforge.net/htmlman/manuals.html">SGE</a>. To learn about templates for other clusters, please consult the <a href="https://github.com/mschubert/clustermq"><code>clustermq</code></a> documentation.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="hpc.html#cb203-1"></a><span class="kw">library</span>(drake)</span>
<span id="cb203-2"><a href="hpc.html#cb203-2"></a></span>
<span id="cb203-3"><a href="hpc.html#cb203-3"></a><span class="co"># The targets just collect the process IDs of the callr processes.</span></span>
<span id="cb203-4"><a href="hpc.html#cb203-4"></a>plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(</span>
<span id="cb203-5"><a href="hpc.html#cb203-5"></a>  <span class="dt">x =</span> furrr<span class="op">::</span><span class="kw">future_map_int</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>()),</span>
<span id="cb203-6"><a href="hpc.html#cb203-6"></a>  <span class="dt">y =</span> furrr<span class="op">::</span><span class="kw">future_map_int</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>())</span>
<span id="cb203-7"><a href="hpc.html#cb203-7"></a>)</span>
<span id="cb203-8"><a href="hpc.html#cb203-8"></a></span>
<span id="cb203-9"><a href="hpc.html#cb203-9"></a><span class="co"># Write a template file for clustermq.</span></span>
<span id="cb203-10"><a href="hpc.html#cb203-10"></a><span class="kw">writeLines</span>(</span>
<span id="cb203-11"><a href="hpc.html#cb203-11"></a>  <span class="kw">c</span>(</span>
<span id="cb203-12"><a href="hpc.html#cb203-12"></a>    <span class="st">&quot;#!/bin/bash&quot;</span>,</span>
<span id="cb203-13"><a href="hpc.html#cb203-13"></a>    <span class="st">&quot;#$ -N {{ job_name }}               # job name&quot;</span>,</span>
<span id="cb203-14"><a href="hpc.html#cb203-14"></a>    <span class="st">&quot;#$ -t 1-{{ n_jobs }}               # submit jobs as array&quot;</span>,</span>
<span id="cb203-15"><a href="hpc.html#cb203-15"></a>    <span class="st">&quot;#$ -j y                            # combine stdout/error in one file&quot;</span>,</span>
<span id="cb203-16"><a href="hpc.html#cb203-16"></a>    <span class="st">&quot;#$ -o {{ log_file | /dev/null }}   # output file&quot;</span>,</span>
<span id="cb203-17"><a href="hpc.html#cb203-17"></a>    <span class="st">&quot;#$ -cwd                            # use pwd as work dir&quot;</span>,</span>
<span id="cb203-18"><a href="hpc.html#cb203-18"></a>    <span class="st">&quot;#$ -V                              # use environment variables&quot;</span>,</span>
<span id="cb203-19"><a href="hpc.html#cb203-19"></a>    <span class="st">&quot;#$ -pe smp 4                       # request 4 cores per job&quot;</span>,</span>
<span id="cb203-20"><a href="hpc.html#cb203-20"></a>    <span class="st">&quot;module load R-qualified/3.5.2      # if loading R from an environment module&quot;</span>,</span>
<span id="cb203-21"><a href="hpc.html#cb203-21"></a>    <span class="st">&quot;ulimit -v $(( 1024 * {{ memory | 4096 }} ))&quot;</span>,</span>
<span id="cb203-22"><a href="hpc.html#cb203-22"></a>    <span class="st">&quot;CMQ_AUTH={{ auth }} R --no-save --no-restore -e &#39;clustermq:::worker(</span><span class="ch">\&quot;</span><span class="st">{{ master }}</span><span class="ch">\&quot;</span><span class="st">)&#39;&quot;</span></span>
<span id="cb203-23"><a href="hpc.html#cb203-23"></a>  ),</span>
<span id="cb203-24"><a href="hpc.html#cb203-24"></a>  <span class="st">&quot;sge_clustermq.tmpl&quot;</span></span>
<span id="cb203-25"><a href="hpc.html#cb203-25"></a>)</span>
<span id="cb203-26"><a href="hpc.html#cb203-26"></a></span>
<span id="cb203-27"><a href="hpc.html#cb203-27"></a><span class="co"># Register the scheduler and template file with clustermq.</span></span>
<span id="cb203-28"><a href="hpc.html#cb203-28"></a><span class="kw">options</span>(</span>
<span id="cb203-29"><a href="hpc.html#cb203-29"></a>  <span class="dt">clustermq.scheduler =</span> <span class="st">&quot;sge&quot;</span>,</span>
<span id="cb203-30"><a href="hpc.html#cb203-30"></a>  <span class="dt">clustermq.template =</span> <span class="st">&quot;sge_clustermq.tmpl&quot;</span></span>
<span id="cb203-31"><a href="hpc.html#cb203-31"></a>)</span>
<span id="cb203-32"><a href="hpc.html#cb203-32"></a></span>
<span id="cb203-33"><a href="hpc.html#cb203-33"></a><span class="co"># Build the targets.</span></span>
<span id="cb203-34"><a href="hpc.html#cb203-34"></a><span class="kw">make</span>(</span>
<span id="cb203-35"><a href="hpc.html#cb203-35"></a>  plan,</span>
<span id="cb203-36"><a href="hpc.html#cb203-36"></a>  <span class="dt">parallelism =</span> <span class="st">&quot;clustermq&quot;</span>,</span>
<span id="cb203-37"><a href="hpc.html#cb203-37"></a>  <span class="dt">jobs =</span> <span class="dv">2</span>,</span>
<span id="cb203-38"><a href="hpc.html#cb203-38"></a>  <span class="co"># Each of the two workers can spawn up to 4 local processes.</span></span>
<span id="cb203-39"><a href="hpc.html#cb203-39"></a>  <span class="dt">prework =</span> <span class="kw">quote</span>(future<span class="op">::</span><span class="kw">plan</span>(future.callr<span class="op">::</span>callr))</span>
<span id="cb203-40"><a href="hpc.html#cb203-40"></a>)</span>
<span id="cb203-41"><a href="hpc.html#cb203-41"></a></span>
<span id="cb203-42"><a href="hpc.html#cb203-42"></a><span class="co"># Process IDs of the local workers of x:</span></span>
<span id="cb203-43"><a href="hpc.html#cb203-43"></a><span class="kw">readd</span>(x) </span></code></pre></div>
</div>
<div id="transient-workers-1" class="section level4" number="12.7.6.3">
<h4><span class="header-section-number">12.7.6.3</span> Transient workers</h4>
<p>As explained in the <a href="https://cran.r-project.org/web/packages/future/vignettes/future-1-overview.html"><code>future</code> vignette</a>, we can nest our <code>future::plans()</code>. Each target gets its own remote job, and each job can spawn up to 4 local <code>callr</code> processes. The following example uses <a href="http://gridscheduler.sourceforge.net/htmlman/manuals.html">SGE</a>. To learn about templates for other clusters, please consult the <a href="https://github.com/HenrikBengtsson/future.batchtools"><code>future.batchtools</code></a> documentation.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="hpc.html#cb204-1"></a><span class="kw">library</span>(drake)</span>
<span id="cb204-2"><a href="hpc.html#cb204-2"></a></span>
<span id="cb204-3"><a href="hpc.html#cb204-3"></a><span class="co"># The targets just collect the process IDs of the callr processes.</span></span>
<span id="cb204-4"><a href="hpc.html#cb204-4"></a>plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(</span>
<span id="cb204-5"><a href="hpc.html#cb204-5"></a>  <span class="dt">x =</span> furrr<span class="op">::</span><span class="kw">future_map_int</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>()),</span>
<span id="cb204-6"><a href="hpc.html#cb204-6"></a>  <span class="dt">y =</span> furrr<span class="op">::</span><span class="kw">future_map_int</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>())</span>
<span id="cb204-7"><a href="hpc.html#cb204-7"></a>)</span>
<span id="cb204-8"><a href="hpc.html#cb204-8"></a></span>
<span id="cb204-9"><a href="hpc.html#cb204-9"></a><span class="co"># Write a template file for future.batchtools.</span></span>
<span id="cb204-10"><a href="hpc.html#cb204-10"></a><span class="kw">writeLines</span>(</span>
<span id="cb204-11"><a href="hpc.html#cb204-11"></a>  <span class="kw">c</span>(</span>
<span id="cb204-12"><a href="hpc.html#cb204-12"></a>    <span class="st">&quot;#!/bin/bash&quot;</span>,</span>
<span id="cb204-13"><a href="hpc.html#cb204-13"></a>    <span class="st">&quot;#$ -cwd                # use pwd as work dir&quot;</span>,</span>
<span id="cb204-14"><a href="hpc.html#cb204-14"></a>    <span class="st">&quot;#$ -j y                # combine stdout/error in one file&quot;</span>,</span>
<span id="cb204-15"><a href="hpc.html#cb204-15"></a>    <span class="st">&quot;#$ -o &lt;%= log.file %&gt;  # output file&quot;</span>,</span>
<span id="cb204-16"><a href="hpc.html#cb204-16"></a>    <span class="st">&quot;#$ -V                  # use environment variables&quot;</span>,</span>
<span id="cb204-17"><a href="hpc.html#cb204-17"></a>    <span class="st">&quot;#$ -N &lt;%= job.name %&gt;  # job name&quot;</span>,</span>
<span id="cb204-18"><a href="hpc.html#cb204-18"></a>    <span class="st">&quot;#$ -pe smp 4           # 4 cores per job&quot;</span>,</span>
<span id="cb204-19"><a href="hpc.html#cb204-19"></a>    <span class="st">&quot;module load R          # if loading R from an environment module&quot;</span>,</span>
<span id="cb204-20"><a href="hpc.html#cb204-20"></a>    <span class="st">&quot;Rscript -e &#39;batchtools::doJobCollection(</span><span class="ch">\&quot;</span><span class="st">&lt;%= uri %&gt;</span><span class="ch">\&quot;</span><span class="st">)&#39;&quot;</span>,</span>
<span id="cb204-21"><a href="hpc.html#cb204-21"></a>    <span class="st">&quot;exit 0&quot;</span></span>
<span id="cb204-22"><a href="hpc.html#cb204-22"></a>  ),</span>
<span id="cb204-23"><a href="hpc.html#cb204-23"></a>  <span class="st">&quot;sge_batchtools.tmpl&quot;</span></span>
<span id="cb204-24"><a href="hpc.html#cb204-24"></a>)</span>
<span id="cb204-25"><a href="hpc.html#cb204-25"></a></span>
<span id="cb204-26"><a href="hpc.html#cb204-26"></a><span class="co"># In our nested plans, each target gets its own remote SGE job,</span></span>
<span id="cb204-27"><a href="hpc.html#cb204-27"></a><span class="co"># and each worker can spawn up to 4 `callr` processes.</span></span>
<span id="cb204-28"><a href="hpc.html#cb204-28"></a>future<span class="op">::</span><span class="kw">plan</span>(</span>
<span id="cb204-29"><a href="hpc.html#cb204-29"></a>  <span class="kw">list</span>(</span>
<span id="cb204-30"><a href="hpc.html#cb204-30"></a>    future<span class="op">::</span><span class="kw">tweak</span>(</span>
<span id="cb204-31"><a href="hpc.html#cb204-31"></a>      future.batchtools<span class="op">::</span>batchtools_sge,</span>
<span id="cb204-32"><a href="hpc.html#cb204-32"></a>      <span class="dt">template =</span> <span class="st">&quot;sge_batchtools.tmpl&quot;</span></span>
<span id="cb204-33"><a href="hpc.html#cb204-33"></a>    ),</span>
<span id="cb204-34"><a href="hpc.html#cb204-34"></a>    future.callr<span class="op">::</span>callr</span>
<span id="cb204-35"><a href="hpc.html#cb204-35"></a>  )</span>
<span id="cb204-36"><a href="hpc.html#cb204-36"></a>)</span>
<span id="cb204-37"><a href="hpc.html#cb204-37"></a></span>
<span id="cb204-38"><a href="hpc.html#cb204-38"></a><span class="co"># Build the targets.</span></span>
<span id="cb204-39"><a href="hpc.html#cb204-39"></a><span class="kw">make</span>(plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</span>
<span id="cb204-40"><a href="hpc.html#cb204-40"></a></span>
<span id="cb204-41"><a href="hpc.html#cb204-41"></a><span class="co"># Process IDs of the local workers of x:</span></span>
<span id="cb204-42"><a href="hpc.html#cb204-42"></a><span class="kw">readd</span>(x)</span></code></pre></div>
</div>
<div id="number-of-local-workers-per-target" class="section level4" number="12.7.6.4">
<h4><span class="header-section-number">12.7.6.4</span> Number of local workers per target</h4>
<p>By default, <code>future::availableCores()</code> determines the number of local <a href="https://github.com/r-lib/callr"><code>callr</code></a> workers. To better manage resources, you may wish to further restrict the number of <a href="https://github.com/r-lib/callr"><code>callr</code></a> workers for all targets in the plan, e.g. <code>future::plan(future::callr, workers = 4L)</code> or:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="hpc.html#cb205-1"></a>future<span class="op">::</span><span class="kw">plan</span>(</span>
<span id="cb205-2"><a href="hpc.html#cb205-2"></a>  <span class="kw">list</span>(</span>
<span id="cb205-3"><a href="hpc.html#cb205-3"></a>    future<span class="op">::</span><span class="kw">tweak</span>(</span>
<span id="cb205-4"><a href="hpc.html#cb205-4"></a>      future.batchtools<span class="op">::</span>batchtools_sge,</span>
<span id="cb205-5"><a href="hpc.html#cb205-5"></a>      <span class="dt">template =</span> <span class="st">&quot;sge_batchtools.tmpl&quot;</span></span>
<span id="cb205-6"><a href="hpc.html#cb205-6"></a>    ),</span>
<span id="cb205-7"><a href="hpc.html#cb205-7"></a>    future<span class="op">::</span><span class="kw">tweak</span>(future.callr<span class="op">::</span>callr, <span class="dt">workers =</span> 4L)</span>
<span id="cb205-8"><a href="hpc.html#cb205-8"></a>  )</span>
<span id="cb205-9"><a href="hpc.html#cb205-9"></a>)</span></code></pre></div>
<p>Alternatively, you can use chunking to prevent individual targets from using too many workers, e.g. <code>furrr::future_map(.options = furrr::future_options(scheduling = 4))</code>. Here, the <code>scheduling</code> argument sets the average number of futures per worker.</p>
</div>
<div id="locked-bindingenvironment-errors" class="section level4" number="12.7.6.5">
<h4><span class="header-section-number">12.7.6.5</span> Locked binding/environment errors</h4>
<p>Some workflows unavoidably use <code>mclapply()</code>, which is known to modify the global environment against <code>drake</code>’s will. If you are stuck, there are two workarounds.</p>
<ol style="list-style-type: decimal">
<li>Use <code>make(lock_envir = FALSE)</code>.</li>
<li>Use the <code>envir</code> argument of <code>make()</code>. That way, <code>drake</code> locks your special custom environment instead of the global environment.</li>
</ol>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="hpc.html#cb206-1"></a><span class="co"># Load the main example: https://github.com/wlandau/drake-examples</span></span>
<span id="cb206-2"><a href="hpc.html#cb206-2"></a><span class="kw">library</span>(drake)</span>
<span id="cb206-3"><a href="hpc.html#cb206-3"></a><span class="kw">drake_example</span>(<span class="st">&quot;main&quot;</span>)</span>
<span id="cb206-4"><a href="hpc.html#cb206-4"></a><span class="kw">setwd</span>(<span class="st">&quot;main&quot;</span>)</span>
<span id="cb206-5"><a href="hpc.html#cb206-5"></a></span>
<span id="cb206-6"><a href="hpc.html#cb206-6"></a><span class="co"># Define and populate a special custom environment.</span></span>
<span id="cb206-7"><a href="hpc.html#cb206-7"></a>envir &lt;-<span class="st"> </span><span class="kw">new.env</span>(<span class="dt">parent =</span> <span class="kw">globalenv</span>())</span>
<span id="cb206-8"><a href="hpc.html#cb206-8"></a><span class="kw">source</span>(<span class="st">&quot;R/packages.R&quot;</span>, <span class="dt">local =</span> envir)</span>
<span id="cb206-9"><a href="hpc.html#cb206-9"></a><span class="kw">source</span>(<span class="st">&quot;R/functions.R&quot;</span>, <span class="dt">local =</span> envir)</span>
<span id="cb206-10"><a href="hpc.html#cb206-10"></a><span class="kw">source</span>(<span class="st">&quot;R/plan.R&quot;</span>, <span class="dt">local =</span> envir)</span>
<span id="cb206-11"><a href="hpc.html#cb206-11"></a></span>
<span id="cb206-12"><a href="hpc.html#cb206-12"></a><span class="co"># Check the contents of your environments.</span></span>
<span id="cb206-13"><a href="hpc.html#cb206-13"></a><span class="kw">ls</span>(envir) <span class="co"># Should have your functions and plan</span></span>
<span id="cb206-14"><a href="hpc.html#cb206-14"></a><span class="kw">ls</span>()         <span class="co"># The global environment should only have what you started with.</span></span>
<span id="cb206-15"><a href="hpc.html#cb206-15"></a></span>
<span id="cb206-16"><a href="hpc.html#cb206-16"></a><span class="co"># Build the targets using your custom environment</span></span>
<span id="cb206-17"><a href="hpc.html#cb206-17"></a><span class="kw">make</span>(envir<span class="op">$</span>plan, <span class="dt">envir =</span> envir)</span></code></pre></div>

</div>
</div>
</div>
</div>
<div style = "background: #1C356D; color: white; padding: 10px 10px 10px 25px; font-size: 1em; width: 100%;">
  Copyright Eli Lilly and Company
</div>
            </section>

          </div>
        </div>
      </div>
<a href="gsp.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="time.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ropensci-books/drake/edit/master/hpc.Rmd",
"text": "Edit this chapter"
},
"history": {
"link": "https://github.com/ropensci-books/drake/commits/master/hpc.Rmd",
"text": "Chapter edit history"
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
